## Functionality
The typegen module contains classes/functions to unify trace data and generate files with type hints in the unified trace data. It also offers a command to execute the typegen workflow.

## Foundations & Principles

The project's approach to annotating is CST-based transformation; 

We offer both inline and stub-based annotation generation, whose mechanics, both shared and individual, have been split into CST transformers.
By reading in files that have been traced, which are stored in the ['Filename' column of the trace data](tracing.md#api), trace data can be collected on a per-file basis and applied appropriately.
Specifically, from this per-file basis trace data, annotations (also called type hints) can be generated for each file using the aforementioned transformers, and output appropriately.

## Command
Options are:
```
-p, --path PATH                 Path to project directory  [required]
-u, --unifiers TEXT             Unifier to apply, as given by `name` in
                              pytypes.toml under [[unifier]]
-g, --gen-strat [stub|inline|eval_inline]
                              Select a strategy for generating type hints
                              [required]
-v, --verbose                   INFO if not given, else CRITICAL
--help                          Show this message and exit.
```
Path: The path to the project repository, containing the trace data.
Unifiers: The unifier/filter IDs to apply to the trace data.
Gen-Strat: The ID of the type hint generator to be used.

Example usage: 

`python3.10 main.py typegen -p /project_path/ -u mt -u dupl -u mult2 -u dupl -u first -g eval_inline`

On executing the command, the following steps are done:
### Trace Data File Collection & Deserialization

The trace data files which have been generated by [tracing](tracing.md) have to be collected and deserialized into one single dataframe. 
This is done by using the [trace data file collector](#tracedatafilecollector).

### Unification

The trace data must be cleaned and appropriately unified to remove redundant data so that one type hint is assigned to each traced variable. 
To this extent, [filters](#filters) with a common interface have been implemented to cover unification needs.
Multiple unifiers/filters can be used on the trace data by specifying it in the typegen command. 
Note: To find out which unifier is assigned to which ID, the configuration file `pytypes.toml` in the project repository specified by the path option is used.

### Type Hint Generation

After unifying the trace data, the [type hint generator](#type-hint-generators) is used to generate the files with traced type hints. 
Which type hint generator is used is specified by the `gen-strat` option.
## API
You can find the usage of the classes/its instances by checking their corresponding tests.
### TraceDataFileCollector
Given a folder path, collects trace data files and deserializes them into one single trace data dataframe.
### Filters

Filters are filters which filter the trace data and return the processed trace data. 
The processed trace data can also be filtered by any filter. 
The following filters exist:

* Drop Duplicates - Drops all duplicates in the trace data. Used to remove duplicates.
* Drop Test Functions - Drops all data about test functions. Used to remove data about test functions to prevent test functions to be annotated by the [type hint generator](#type-hint-generators).
* Drop of multiple types - Drops rows containing variables of multiple types.
* Min-Threshold - Drops all rows whose types appear less often than the minimum threshold.
* Keep only first - Keeps only the first row of each variable. Used to ensure that each variable in the trace data has only one type hint. Often used as the last filter.
* Unify subtypes - Replaces rows containing types of the same variable in the data with their common base type. Does not replace if the common base type is `ABC`, `ABCMeta` or `object`. 
Used to unify the traced type hints of the variables. The instance can also be defined so that only type hints are replaced if the common base type is also in the trace data.
* Union - Replaces rows containing types of the same variable in the data with the union of these types. Used to unify the traced type hints of the variables.
* Filter List - Applies the filters in this list on the trace data. Used to filter the trace data with multiple filters, one-by-one. This is possible due to the common base class.
### Type Hint Generators

Type Hint Generators are instances which generate the files with traced type hints using the filtered trace data. As the trace data contains the filenames,  The constraint of the trace data is that to each variable, only one type hint exists. 
The following generators exist:

* InlineGenerator - Overwrites the files by adding the traced type hints to the variables. Does not overwrite existing type hints. Used to add traced type hints to variables in the files in the traced project.
* EvaluationInlineGenerator - Overwrites the files by adding the traced type hints to the variables. Before adding the type hints, existing type hints are removed. Used to [evaluate the traced type hints compared with the existing type hints](evaluating.md).
* StubFileGenerator - Generates the stub files of the affected files with the traced type hints. Existing type hints are kept. The modification of the code matches with the InlineGenerator. However, instead of overwriting the file, the corresponding stub file is generated. Used to generate stubs from the files, additionally containing the traced type hints.

#### Transformers

To apply changes to the files/add type hints to the code, the code in the file is parsed into a CST (Concrete syntax tree). The motivation for using CSTs instead of ASTs is to keep the comments in the files which are dropped when parsing to an AST.
Modifying the CSTs is done by transformers which visit the nodes in the trees and modify these if necessary. The following transformers are used to achieve the functionality of the type hint generators:

* TypeHintTransformer - Updates aug-/assign, function definition & function parameter nodes by adding the traced type hints to the corresponding variables if that variable is in the trace data. If an already existing type hint exists, the node will not be changed.
Used to add traced type hints to global, local variables and class members in assignments, to function parameters and function return in function definitions.
* RemoveAllTypeHintsTransformer - Updates annotated assign, function definition & function parameter nodes by removing the existing type hints. 
Used by the evaluation inline generator to remove existing type hints of global, local variables and class members in assignments, to function parameters and function return in function definitions.
* AddImportTransformer - Transforms the CST by adding Import-From nodes to import the modules of the type hints in the trace data. 
Used to update the code in the files so that the modules of the added type hints are imported.
* MyPyHintTransformer - Uses the current CST to generate the corresponding stub CST. This is done by saving the CST code in a temporary file, generating the corresponding stub file (also as a temporary file) using `mypy.stubgen` and parsing the stub file contents into the stub CST.
Used by the stub file generator to generate the stub CST after adding the traced type hints to the CST.
* ImportUnionTransformer - Transforms the CST by adding the Import-From node to import `Union` from `typing` (`from typing import Union`) if the corresponding code contains a type hint which uses `Union`.
Used by the stub file generator to add the missing import in the stub CST as `mypy.stubgen` annotates with `Union`, but does not add the corresponding import.
